name: DevSecOps Pro (Notifications Intelligentes)

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - 'infra/**'

jobs:
  # ====================================================
  # JOB 1 : S√âCURIT√â & CONSTRUCTION
  # ====================================================
  build-secure-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ----------------------------------------------------
      # 1. SCAN DE SECRETS (TruffleHog)
      # ----------------------------------------------------
      - name: TruffleHog Secret Scan
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          extra_args: --debug --no-verification # --fail force l'arr√™t si secret trouv√©

      # üö® CAS 1 : ALERTE SECRET (Se lance uniquement si TruffleHog √©choue)
      - name: ‚ò¢Ô∏è Email Alerte Secret
        if: failure() && steps.trufflehog.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ò¢Ô∏è ALERTE S√âCURIT√â : Secret D√©tect√© !"
          to: soumia@gmail.com
          from: Sentinel Bot <soumia@gmail.com>
          body: |
            URGENT : Un secret (cl√© API, mot de passe) a √©t√© d√©tect√© dans le code.
            Le d√©ploiement a √©t√© bloqu√© imm√©diatement.
            
            üë§ Auteur : ${{ github.actor }}
            üìù Message : ${{ github.event.head_commit.message }}
            
            ACTION REQUISE :
            1. Supprimez le secret du code.
            2. Changez le mot de passe/cl√© (consid√©rez-le comme compromis).
            3. Nettoyez l'historique Git.

      # ----------------------------------------------------
      # 2. CONSTRUCTION DOCKER
      # ----------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and Push to Docker Hub
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:buildcache,mode=max

      # üö® CAS 3 (Partie 1) : √âCHEC TECHNIQUE (Build)
      - name: üî¥ Email √âchec Build
        if: failure() && steps.docker_build.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî¥ √âCHEC : Erreur de Construction Docker"
          to: soumia@gmail.com
          from: Sentinel Bot <soumia@gmail.com>
          body: |
            Le Pipeline a √©chou√© lors de la construction de l'image Docker.
            V√©rifiez le Dockerfile ou les d√©pendances Python.
            
            Voir les logs : https://github.com/${{ github.repository }}/actions

      # ----------------------------------------------------
      # 3. SCAN DE VULN√âRABILIT√âS (Trivy)
      # ----------------------------------------------------
      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:latest'
          format: 'table'
          # ICI : On met exit-code '1' pour BLOQUER si faille critique trouv√©e
          exit-code: '1' 
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL' # On ne bloque que sur les critiques

      # üö® CAS 2 : ALERTE VULN√âRABILIT√â (Se lance uniquement si Trivy √©choue)
      - name: üõ°Ô∏è Email Alerte Trivy
        if: failure() && steps.trivy.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üõ°Ô∏è ALERTE S√âCURIT√â : Faille Critique Docker !"
          to: soumia@gmail.com
          from: Sentinel Bot <soumia@gmail.com>
          body: |
            STOP : Une vuln√©rabilit√© CRITIQUE a √©t√© trouv√©e dans l'image Docker.
            Le d√©ploiement a √©t√© annul√© par s√©curit√©.
            
            Consultez le rapport Trivy dans les logs GitHub pour voir le d√©tail (CVE).
            
            Lien : https://github.com/${{ github.repository }}/actions

  # ====================================================
  # JOB 2 : D√âPLOIEMENT
  # ====================================================
  deploy:
    needs: build-secure-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        id: deploy_ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: DOCKER_USERNAME 
          script: |
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:latest
            sudo docker stop sentinel || true
            sudo docker rm sentinel || true
            sudo docker run -d -p 80:80 --name sentinel ${{ secrets.DOCKER_USERNAME }}/cloud-sentinel:latest

      # üö® CAS 3 (Partie 2) : √âCHEC TECHNIQUE (Deploy)
      - name: üî¥ Email √âchec D√©ploiement
        if: failure() && steps.deploy_ssh.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üî¥ √âCHEC : Le serveur ne r√©pond pas"
          to: soumia@gmail.com
          from: Sentinel Bot <soumia@gmail.com>
          body: |
            Impossible de se connecter au serveur EC2 ou de lancer le conteneur.
            V√©rifiez l'√©tat du serveur AWS et les cl√©s SSH.